name: Build and Release

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      release_id: ${{ steps.create_release.outputs.id }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get short SHA
        id: slug
        run: echo "sha8=$(echo ${GITHUB_SHA} | cut -c1-8)" >> $GITHUB_OUTPUT

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: build-${{ steps.slug.outputs.sha8 }}
          release_name: Build ${{ steps.slug.outputs.sha8 }}
          body: |
            Automated build from commit ${{ github.sha }}

            **Changes:**
            ${{ github.event.head_commit.message }}

            **Downloads:**
            - Linux: `notebook-linux-x86_64.AppImage`
            - Windows: `notebook-windows-x86_64.zip`
            - macOS: `notebook-macos-x86_64.dmg` and `notebook-macos-arm64.dmg`
          draft: false
          prerelease: false

  build-linux:
    name: Build Linux AppImage
    needs: create-release
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libgtksourceview-4-dev \
            pkg-config \
            wget \
            file \
            desktop-file-utils

      - name: Build application
        run: |
          make release

      - name: Download linuxdeploy and GTK plugin
        run: |
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          wget -q https://raw.githubusercontent.com/linuxdeploy/linuxdeploy-plugin-gtk/master/linuxdeploy-plugin-gtk.sh
          chmod +x linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-plugin-gtk.sh

      - name: Create AppDir structure
        run: |
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          mkdir -p AppDir/usr/share/styles

          # Copy binary
          cp build/bin/notebook AppDir/usr/bin/

          # Copy styles
          cp -r styles/* AppDir/usr/share/styles/

          # Create desktop file
          cat > AppDir/usr/share/applications/notebook.desktop << 'EOF'
          [Desktop Entry]
          Name=Notebook
          Comment=A simple text editor
          Exec=notebook
          Icon=notebook
          Type=Application
          Categories=Utility;TextEditor;
          Terminal=false
          EOF

          # Create a simple icon (you can replace this with a real icon later)
          cat > AppDir/usr/share/icons/hicolor/256x256/apps/notebook.svg << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <svg width="256" height="256" version="1.1" xmlns="http://www.w3.org/2000/svg">
            <rect width="256" height="256" fill="#4a90e2"/>
            <text x="128" y="140" font-family="sans-serif" font-size="120" fill="white" text-anchor="middle">N</text>
          </svg>
          EOF

      - name: Create AppImage
        run: |
          export DEPLOY_GTK_VERSION=3
          export OUTPUT=notebook-linux-x86_64.AppImage
          ./linuxdeploy-x86_64.AppImage \
            --appdir AppDir \
            --plugin gtk \
            --output appimage \
            --desktop-file AppDir/usr/share/applications/notebook.desktop \
            --icon-file AppDir/usr/share/icons/hicolor/256x256/apps/notebook.svg

      - name: Upload Linux AppImage
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./notebook-linux-x86_64.AppImage
          asset_name: notebook-linux-x86_64.AppImage
          asset_content_type: application/octet-stream

  build-windows:
    name: Build Windows Executable
    needs: create-release
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-gtk3
            mingw-w64-x86_64-gtksourceview4
            mingw-w64-x86_64-pkg-config
            make
            zip

      - name: Build application
        run: |
          make release

      - name: Create distribution package
        run: |
          mkdir -p dist/notebook

          # Copy executable
          cp build/bin/notebook.exe dist/notebook/

          # Copy styles
          cp -r styles dist/notebook/

          # Find and copy GTK runtime DLLs
          mkdir -p dist/notebook/bin

          # Copy all necessary DLLs from MINGW64
          ldd build/bin/notebook.exe | grep mingw64 | awk '{print $3}' | xargs -I {} cp {} dist/notebook/bin/

          # Copy GTK runtime files
          mkdir -p dist/notebook/share
          cp -r /mingw64/share/glib-2.0 dist/notebook/share/
          cp -r /mingw64/share/icons dist/notebook/share/
          cp -r /mingw64/share/gtksourceview-4 dist/notebook/share/

          # Copy GTK schemas
          mkdir -p dist/notebook/share/glib-2.0/schemas
          cp /mingw64/share/glib-2.0/schemas/* dist/notebook/share/glib-2.0/schemas/
          glib-compile-schemas dist/notebook/share/glib-2.0/schemas/

          # Create launcher script
          cat > dist/notebook/notebook.bat << 'EOF'
          @echo off
          set PATH=%~dp0bin;%PATH%
          set GTK_DATA_PREFIX=%~dp0
          set GDK_PIXBUF_MODULEDIR=%~dp0lib\gdk-pixbuf-2.0\2.10.0\loaders
          set GDK_PIXBUF_MODULE_FILE=%~dp0lib\gdk-pixbuf-2.0\2.10.0\loaders.cache
          "%~dp0notebook.exe" %*
          EOF

          # Create README
          cat > dist/notebook/README.txt << 'EOF'
          Notebook Text Editor for Windows

          To run the application, double-click notebook.bat

          All dependencies are included in this package.
          EOF

          # Create zip
          cd dist
          zip -r ../notebook-windows-x86_64.zip notebook

      - name: Upload Windows Package
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./notebook-windows-x86_64.zip
          asset_name: notebook-windows-x86_64.zip
          asset_content_type: application/zip

  build-macos-x86_64:
    name: Build macOS (Intel)
    needs: create-release
    runs-on: macos-12
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew install gtk+3 gtksourceview4 pkg-config create-dmg

      - name: Build application
        run: |
          make release

      - name: Create App Bundle
        run: |
          # Create app bundle structure
          mkdir -p "Notebook.app/Contents/MacOS"
          mkdir -p "Notebook.app/Contents/Resources"
          mkdir -p "Notebook.app/Contents/Frameworks"
          mkdir -p "Notebook.app/Contents/share"

          # Copy binary
          cp build/bin/notebook "Notebook.app/Contents/MacOS/"

          # Copy styles
          cp -r styles "Notebook.app/Contents/Resources/"

          # Create Info.plist
          cat > "Notebook.app/Contents/Info.plist" << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key>
              <string>notebook</string>
              <key>CFBundleIdentifier</key>
              <string>com.notebook.editor</string>
              <key>CFBundleName</key>
              <string>Notebook</string>
              <key>CFBundleVersion</key>
              <string>1.0</string>
              <key>CFBundleShortVersionString</key>
              <string>1.0</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>NSHighResolutionCapable</key>
              <true/>
          </dict>
          </plist>
          EOF

          # Copy GTK libraries and dependencies
          echo "Copying libraries..."
          otool -L build/bin/notebook | grep -E '(gtk|gdk|glib|gobject|gio|pango|cairo|atk|gtksourceview)' | awk '{print $1}' | while read lib; do
            if [ -f "$lib" ]; then
              cp "$lib" "Notebook.app/Contents/Frameworks/"
            fi
          done

          # Copy Homebrew GTK dependencies
          for lib in /opt/homebrew/lib/*.dylib /usr/local/lib/*.dylib; do
            if [ -f "$lib" ]; then
              libname=$(basename "$lib")
              if [[ "$libname" == *"gtk"* ]] || [[ "$libname" == *"gdk"* ]] || [[ "$libname" == *"glib"* ]] || [[ "$libname" == *"gobject"* ]] || [[ "$libname" == *"pango"* ]] || [[ "$libname" == *"cairo"* ]] || [[ "$libname" == *"gtksourceview"* ]]; then
                cp "$lib" "Notebook.app/Contents/Frameworks/" 2>/dev/null || true
              fi
            fi
          done

          # Copy GTK runtime files
          for prefix in /opt/homebrew /usr/local; do
            if [ -d "$prefix/share/gtksourceview-4" ]; then
              cp -r "$prefix/share/gtksourceview-4" "Notebook.app/Contents/share/"
            fi
            if [ -d "$prefix/share/glib-2.0" ]; then
              cp -r "$prefix/share/glib-2.0" "Notebook.app/Contents/share/"
            fi
          done

          # Fix library paths
          echo "Fixing library paths..."
          install_name_tool -add_rpath "@executable_path/../Frameworks" "Notebook.app/Contents/MacOS/notebook" || true

      - name: Create DMG
        run: |
          create-dmg \
            --volname "Notebook" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --app-drop-link 450 185 \
            "notebook-macos-x86_64.dmg" \
            "Notebook.app"

      - name: Upload macOS DMG
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./notebook-macos-x86_64.dmg
          asset_name: notebook-macos-x86_64.dmg
          asset_content_type: application/octet-stream

  build-macos-arm64:
    name: Build macOS (Apple Silicon)
    needs: create-release
    runs-on: macos-14
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew install gtk+3 gtksourceview4 pkg-config create-dmg

      - name: Build application
        run: |
          make release

      - name: Create App Bundle
        run: |
          # Create app bundle structure
          mkdir -p "Notebook.app/Contents/MacOS"
          mkdir -p "Notebook.app/Contents/Resources"
          mkdir -p "Notebook.app/Contents/Frameworks"
          mkdir -p "Notebook.app/Contents/share"

          # Copy binary
          cp build/bin/notebook "Notebook.app/Contents/MacOS/"

          # Copy styles
          cp -r styles "Notebook.app/Contents/Resources/"

          # Create Info.plist
          cat > "Notebook.app/Contents/Info.plist" << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key>
              <string>notebook</string>
              <key>CFBundleIdentifier</key>
              <string>com.notebook.editor</string>
              <key>CFBundleName</key>
              <string>Notebook</string>
              <key>CFBundleVersion</key>
              <string>1.0</string>
              <key>CFBundleShortVersionString</key>
              <string>1.0</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>NSHighResolutionCapable</key>
              <true/>
          </dict>
          </plist>
          EOF

          # Copy GTK libraries and dependencies
          echo "Copying libraries..."
          otool -L build/bin/notebook | grep -E '(gtk|gdk|glib|gobject|gio|pango|cairo|atk|gtksourceview)' | awk '{print $1}' | while read lib; do
            if [ -f "$lib" ]; then
              cp "$lib" "Notebook.app/Contents/Frameworks/"
            fi
          done

          # Copy Homebrew GTK dependencies
          for lib in /opt/homebrew/lib/*.dylib /usr/local/lib/*.dylib; do
            if [ -f "$lib" ]; then
              libname=$(basename "$lib")
              if [[ "$libname" == *"gtk"* ]] || [[ "$libname" == *"gdk"* ]] || [[ "$libname" == *"glib"* ]] || [[ "$libname" == *"gobject"* ]] || [[ "$libname" == *"pango"* ]] || [[ "$libname" == *"cairo"* ]] || [[ "$libname" == *"gtksourceview"* ]]; then
                cp "$lib" "Notebook.app/Contents/Frameworks/" 2>/dev/null || true
              fi
            fi
          done

          # Copy GTK runtime files
          for prefix in /opt/homebrew /usr/local; do
            if [ -d "$prefix/share/gtksourceview-4" ]; then
              cp -r "$prefix/share/gtksourceview-4" "Notebook.app/Contents/share/"
            fi
            if [ -d "$prefix/share/glib-2.0" ]; then
              cp -r "$prefix/share/glib-2.0" "Notebook.app/Contents/share/"
            fi
          done

          # Fix library paths
          echo "Fixing library paths..."
          install_name_tool -add_rpath "@executable_path/../Frameworks" "Notebook.app/Contents/MacOS/notebook" || true

      - name: Create DMG
        run: |
          create-dmg \
            --volname "Notebook" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --app-drop-link 450 185 \
            "notebook-macos-arm64.dmg" \
            "Notebook.app"

      - name: Upload macOS DMG
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./notebook-macos-arm64.dmg
          asset_name: notebook-macos-arm64.dmg
          asset_content_type: application/octet-stream
